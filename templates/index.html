<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agvisor - AI Advisory for Agricultural Businesses</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="onboardingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-tractor"></i>
                </div>
                <h2>Welcome to Agvisor</h2>
                <p>Set up your business profile to get personalized advice from our AI advisory board</p>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label for="businessName">Business Name (Optional)</label>
                    <input type="text" id="businessName" placeholder="e.g., Green Valley Ag Supply">
                </div>
                
                <div class="form-group">
                    <label for="stateSelect">State <span class="required">*</span></label>
                    <select id="stateSelect" required>
                        <option value="">Select your state...</option>
                        {% for state in states %}
                        <option value="{{ state }}">{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="businessType">Business Type <span class="required">*</span></label>
                    <select id="businessType" required>
                        <option value="">Select your business type...</option>
                        <option value="Row Crop Farm">Row Crop Farm</option>
                        <option value="Livestock Operation">Livestock Operation</option>
                        <option value="Mixed Farming">Mixed Farming (Crops & Livestock)</option>
                        <option value="Dairy Operation">Dairy Operation</option>
                        <option value="Specialty Crop / Horticulture">Specialty Crop / Horticulture</option>
                        <option value="Vineyard / Winery">Vineyard / Winery</option>
                        <option value="Orchard">Orchard</option>
                        <option value="Nursery / Greenhouse">Nursery / Greenhouse</option>
                        <option value="Ag Equipment Dealer / Service">Ag Equipment Dealer / Service</option>
                        <option value="Ag Input Supplier">Ag Input Supplier (Seed, Feed, Fertilizer)</option>
                        <option value="Grain Elevator / Storage">Grain Elevator / Storage</option>
                        <option value="Food Processing / Packing">Food Processing / Packing</option>
                        <option value="Ag Tech / Precision Ag">Ag Tech / Precision Ag</option>
                        <option value="Ag Finance / Lending">Ag Finance / Lending</option>
                        <option value="Ag Consulting">Ag Consulting</option>
                        <option value="Cooperative">Cooperative</option>
                        <option value="Other Ag Business">Other Ag Business</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="businessDescription">Describe Your Business <span class="required">*</span></label>
                    <p class="form-hint">Tell us what you do â€” products, services, scale, etc.</p>
                    <textarea id="businessDescription" rows="3" placeholder="e.g., 2,000-acre corn and soybean operation, also sell seed to neighboring farms" required></textarea>
                </div>

                <div class="form-group">
                    <label>Build Your Advisory Board</label>
                    <p class="form-hint">Your board always includes 5 core advisors. Add optional specialists below.</p>
                    
                    <div class="base-advisors-info">
                        <p class="board-section-label"><i class="fas fa-lock"></i> Core Board Members (always active)</p>
                        <div class="base-advisor-chips">
                            {% for id, advisor in base_advisors.items() %}
                            <span class="advisor-chip base-chip">
                                <i class="fas fa-{{ advisor.icon }}"></i> {{ advisor.title }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="optional-advisors-section">
                        <p class="board-section-label"><i class="fas fa-plus-circle"></i> Optional Specialists</p>
                        <div id="boardSuggestion" class="board-suggestion" style="display: none;"></div>
                        <div class="optional-advisor-list">
                            {% for id, advisor in optional_advisors.items() %}
                            <label class="optional-advisor-checkbox" data-advisor-id="{{ id }}">
                                <input type="checkbox" name="optional_advisors" value="{{ id }}">
                                <div class="advisor-checkbox-card">
                                    <div class="advisor-checkbox-icon">
                                        <i class="fas fa-{{ advisor.icon }}"></i>
                                    </div>
                                    <div class="advisor-checkbox-info">
                                        <strong>{{ advisor.title }}</strong>
                                        <span>{{ advisor.specialty }}</span>
                                    </div>
                                    <div class="advisor-checkbox-check">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Business Records (Optional)</label>
                    <p class="form-hint">Upload a CSV or spreadsheet with your business financial or production data</p>
                    <div class="file-upload-wrapper">
                        <input type="file" id="businessRecords" accept=".csv,.xlsx,.xls">
                        <div class="file-upload-label" id="fileLabel">
                            <i class="fas fa-file-upload"></i>
                            <span>Choose a file or drag it here</span>
                        </div>
                    </div>
                    <p class="form-hint" id="fileStatus" style="margin-top: 0.5rem; color: var(--primary-green); display: none;"></p>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-arrow-right"></i> Start Getting Advice
                </button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-tractor"></i>
                <h1>Agvisor</h1>
            </div>
            <div class="header-right">
                <button class="profile-btn" id="editProfileBtn" title="Edit Profile">
                    <i class="fas fa-user-cog"></i>
                    <span id="profileSummary">Set up profile</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="sidebar-scroll">
                    <h2>Your Advisory Board</h2>
                    <div class="advisor-list" id="advisorList">
                    </div>
                    <div class="sidebar-divider" id="availableSection" style="display:none;">
                        <div class="available-header">
                            <i class="fas fa-plus-circle"></i> Available Specialists
                        </div>
                        <div class="available-advisors" id="availableAdvisors">
                        </div>
                    </div>
                </div>
                <button class="clear-btn" id="clearChat">
                    <i class="fas fa-trash-alt"></i> Clear Conversation
                </button>
            </aside>

            <main class="chat-area">
                <div class="chat-header">
                    <div class="current-advisor">
                        <span>Advisory Board Mode: </span>
                        <strong>All Advisors</strong>
                        <span class="advisor-title">Ask a question to get input from all board members</span>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h2>Welcome to Your Advisory Board</h2>
                        <p>Ask any question about your agricultural business. Your AI-powered board of advisors is here to help with:</p>
                        <ul>
                            <li><i class="fas fa-check"></i> Financial planning and investment decisions</li>
                            <li><i class="fas fa-check"></i> Operations optimization and logistics</li>
                            <li><i class="fas fa-check"></i> Marketing strategies and sales growth</li>
                            <li><i class="fas fa-check"></i> Federal and state agricultural regulations</li>
                            <li><i class="fas fa-check"></i> Risk management and insurance</li>
                        </ul>
                    </div>
                </div>

                <div class="chat-input-area">
                    <form id="chatForm">
                        <div class="input-wrapper">
                            <textarea 
                                id="messageInput" 
                                placeholder="Ask your advisory board a question..."
                                rows="1"
                            ></textarea>
                            <button type="submit" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <script>
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let currentAdvisor = 'financial';
        let isLoading = false;
        let userProfile = null;

        const baseAdvisors = {
            {% for id, advisor in base_advisors.items() %}
            '{{ id }}': {
                title: '{{ advisor.title }}',
                specialty: '{{ advisor.specialty }}',
                icon: '{{ advisor.icon }}'
            },
            {% endfor %}
        };

        const optionalAdvisors = {
            {% for id, advisor in optional_advisors.items() %}
            '{{ id }}': {
                title: '{{ advisor.title }}',
                specialty: '{{ advisor.specialty }}',
                icon: '{{ advisor.icon }}'
            },
            {% endfor %}
        };

        const boardSuggestions = {{ board_suggestions | tojson }};

        const modal = document.getElementById('onboardingModal');
        const profileForm = document.getElementById('profileForm');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const chatForm = document.getElementById('chatForm');
        const clearBtn = document.getElementById('clearChat');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const profileSummary = document.getElementById('profileSummary');
        const advisorList = document.getElementById('advisorList');
        const availableAdvisors = document.getElementById('availableAdvisors');
        const availableSection = document.getElementById('availableSection');
        const businessTypeSelect = document.getElementById('businessType');
        const boardSuggestionDiv = document.getElementById('boardSuggestion');

        function showModal() {
            modal.style.display = 'flex';
        }

        function hideModal() {
            modal.style.display = 'none';
        }

        function getActiveAdvisors() {
            const selected = (userProfile && userProfile.selected_advisors) ? userProfile.selected_advisors : [];
            const active = {...baseAdvisors};
            selected.forEach(id => {
                if (optionalAdvisors[id]) {
                    active[id] = optionalAdvisors[id];
                }
            });
            return active;
        }

        const advisorOrder = ['financial', 'operations', 'marketing', 'legal', 'risk', 'commodity_risk', 'livestock', 'sustainability', 'agronomist'];

        function sortAdvisorIds(ids) {
            return ids.sort((a, b) => {
                return (advisorOrder.indexOf(a) === -1 ? 99 : advisorOrder.indexOf(a)) - (advisorOrder.indexOf(b) === -1 ? 99 : advisorOrder.indexOf(b));
            });
        }

        function createAdvisorCard(id, advisor, opts = {}) {
            const card = document.createElement('div');
            card.className = 'advisor-card' + (opts.draggable ? ' draggable-card' : '') + (opts.removable ? ' removable-card' : '');
            card.dataset.advisor = id;
            if (opts.draggable) {
                card.setAttribute('draggable', 'true');
            }
            card.innerHTML = `
                ${opts.draggable ? `<div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>` : ''}
                <div class="advisor-icon">
                    <i class="fas fa-${advisor.icon}"></i>
                </div>
                <div class="advisor-info">
                    <h3>${advisor.title}</h3>
                    <p class="specialty">${advisor.specialty}</p>
                </div>
                ${opts.draggable ? `<div class="add-advisor-hint"><i class="fas fa-plus"></i></div>` : ''}
                ${opts.removable ? `<button class="remove-advisor-btn" title="Remove from board"><i class="fas fa-times"></i></button>` : ''}
            `;
            return card;
        }

        function renderSidebar() {
            const active = getActiveAdvisors();
            const selectedIds = (userProfile && userProfile.selected_advisors) ? userProfile.selected_advisors : [];

            advisorList.innerHTML = '';
            const activeIds = sortAdvisorIds(Object.keys(active));
            activeIds.forEach(id => {
                const advisor = active[id];
                const isOptional = !!optionalAdvisors[id];
                const card = createAdvisorCard(id, advisor, { removable: isOptional });
                if (isOptional) {
                    card.querySelector('.remove-advisor-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeAdvisorFromBoard(id);
                    });
                }
                advisorList.appendChild(card);
            });

            const unselected = Object.keys(optionalAdvisors).filter(id => !selectedIds.includes(id));
            if (unselected.length > 0) {
                availableSection.style.display = 'block';
                availableAdvisors.innerHTML = '';
                sortAdvisorIds(unselected).forEach(id => {
                    const advisor = optionalAdvisors[id];
                    const card = createAdvisorCard(id, advisor, { draggable: true });
                    setupDragSource(card, id);
                    card.addEventListener('click', () => addAdvisorToBoard(id));
                    availableAdvisors.appendChild(card);
                });
            } else {
                availableSection.style.display = 'none';
            }

            setupDropTarget();
        }

        let draggedAdvisorId = null;
        let dropTargetBound = false;

        function setupDragSource(card, advisorId) {
            card.addEventListener('dragstart', (e) => {
                draggedAdvisorId = advisorId;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', advisorId);
                setTimeout(() => advisorList.classList.add('drop-zone-active'), 0);
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                advisorList.classList.remove('drop-zone-active');
                draggedAdvisorId = null;
            });
        }

        function setupDropTarget() {
            if (dropTargetBound) return;
            dropTargetBound = true;
            advisorList.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                advisorList.classList.add('drop-zone-hover');
            });
            advisorList.addEventListener('dragleave', (e) => {
                if (!advisorList.contains(e.relatedTarget)) {
                    advisorList.classList.remove('drop-zone-hover');
                }
            });
            advisorList.addEventListener('drop', (e) => {
                e.preventDefault();
                advisorList.classList.remove('drop-zone-hover');
                advisorList.classList.remove('drop-zone-active');
                const advisorId = e.dataTransfer.getData('text/plain');
                if (advisorId && optionalAdvisors[advisorId]) {
                    addAdvisorToBoard(advisorId);
                }
            });
        }

        function addAdvisorToBoard(advisorId) {
            if (!userProfile) userProfile = { selected_advisors: [] };
            if (!userProfile.selected_advisors) userProfile.selected_advisors = [];
            if (userProfile.selected_advisors.includes(advisorId)) return;
            userProfile.selected_advisors.push(advisorId);
            syncBoardToBackend();
            renderSidebar();
            syncModalCheckboxes();
        }

        function removeAdvisorFromBoard(advisorId) {
            if (!userProfile || !userProfile.selected_advisors) return;
            userProfile.selected_advisors = userProfile.selected_advisors.filter(id => id !== advisorId);
            syncBoardToBackend();
            renderSidebar();
            syncModalCheckboxes();
        }

        function syncModalCheckboxes() {
            const selected = (userProfile && userProfile.selected_advisors) ? userProfile.selected_advisors : [];
            document.querySelectorAll('.optional-advisor-checkbox input[type="checkbox"]').forEach(cb => {
                const isChecked = selected.includes(cb.value);
                cb.checked = isChecked;
                if (isChecked) {
                    cb.closest('.optional-advisor-checkbox').classList.add('checked');
                } else {
                    cb.closest('.optional-advisor-checkbox').classList.remove('checked');
                }
            });
        }

        function syncBoardToBackend() {
            localStorage.setItem('agvisorProfile', JSON.stringify(userProfile));
            fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    ...userProfile
                })
            });
        }

        function updateProfileSummary() {
            if (userProfile && userProfile.state) {
                let summary = userProfile.state;
                if (userProfile.business_type) {
                    summary += ` - ${userProfile.business_type}`;
                }
                profileSummary.textContent = summary;
            } else {
                profileSummary.textContent = 'Set up profile';
            }
        }

        businessTypeSelect.addEventListener('change', function() {
            const type = this.value;
            const suggestion = boardSuggestions[type];
            
            if (suggestion && suggestion.tip) {
                boardSuggestionDiv.innerHTML = `<i class="fas fa-lightbulb"></i> <strong>Suggestion:</strong> ${suggestion.tip}`;
                boardSuggestionDiv.style.display = 'block';
                
                document.querySelectorAll('.optional-advisor-checkbox input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.optional-advisor-checkbox').classList.remove('checked');
                });
                
                if (suggestion.recommended && suggestion.recommended.length > 0) {
                    suggestion.recommended.forEach(advisorId => {
                        const cb = document.querySelector(`.optional-advisor-checkbox[data-advisor-id="${advisorId}"] input[type="checkbox"]`);
                        if (cb) {
                            cb.checked = true;
                            cb.closest('.optional-advisor-checkbox').classList.add('checked');
                        }
                    });
                }
            } else {
                boardSuggestionDiv.style.display = 'none';
            }
        });

        document.querySelectorAll('.optional-advisor-checkbox input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    this.closest('.optional-advisor-checkbox').classList.add('checked');
                } else {
                    this.closest('.optional-advisor-checkbox').classList.remove('checked');
                }
            });
        });

        const fileInput = document.getElementById('businessRecords');
        const fileLabel = document.getElementById('fileLabel');
        const fileStatus = document.getElementById('fileStatus');
        let uploadedFile = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                fileLabel.innerHTML = `<i class="fas fa-file-check"></i><span>${file.name}</span>`;
                fileLabel.classList.add('file-selected');
            }
        });

        async function uploadBusinessRecords() {
            if (!uploadedFile) return true;
            
            const formData = new FormData();
            formData.append('file', uploadedFile);
            formData.append('session_id', sessionId);
            
            try {
                const response = await fetch('/api/upload-records', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error uploading file: ' + data.error);
                    return false;
                }
                
                fileStatus.textContent = `Uploaded: ${data.row_count} records processed`;
                fileStatus.style.display = 'block';
                return true;
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading file. Please try again.');
                return false;
            }
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const businessName = document.getElementById('businessName').value;
            const state = document.getElementById('stateSelect').value;
            const businessType = document.getElementById('businessType').value;
            const businessDescription = document.getElementById('businessDescription').value.trim();
            
            const selectedAdvisors = [];
            document.querySelectorAll('.optional-advisor-checkbox input[type="checkbox"]:checked').forEach(cb => {
                selectedAdvisors.push(cb.value);
            });
            
            if (!state) {
                alert('Please select your state');
                return;
            }
            
            if (!businessType) {
                alert('Please select your business type');
                return;
            }
            
            if (!businessDescription) {
                alert('Please describe your business');
                return;
            }
            
            userProfile = { 
                business_name: businessName, 
                state, 
                business_type: businessType, 
                business_description: businessDescription,
                selected_advisors: selectedAdvisors
            };
            
            try {
                if (uploadedFile) {
                    const uploadSuccess = await uploadBusinessRecords();
                    if (!uploadSuccess) return;
                }
                
                await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        ...userProfile
                    })
                });
                
                updateProfileSummary();
                renderSidebar();
                hideModal();
                
                localStorage.setItem('agvisorProfile', JSON.stringify(userProfile));
                uploadedFile = null;
            } catch (error) {
                console.error('Error saving profile:', error);
            }
        });

        editProfileBtn.addEventListener('click', () => {
            if (userProfile) {
                document.getElementById('businessName').value = userProfile.business_name || '';
                document.getElementById('stateSelect').value = userProfile.state || '';
                document.getElementById('businessType').value = userProfile.business_type || '';
                document.getElementById('businessDescription').value = userProfile.business_description || '';
                
                document.querySelectorAll('.optional-advisor-checkbox input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.optional-advisor-checkbox').classList.remove('checked');
                });
                
                if (userProfile.selected_advisors) {
                    userProfile.selected_advisors.forEach(advisorId => {
                        const cb = document.querySelector(`.optional-advisor-checkbox[data-advisor-id="${advisorId}"] input[type="checkbox"]`);
                        if (cb) {
                            cb.checked = true;
                            cb.closest('.optional-advisor-checkbox').classList.add('checked');
                        }
                    });
                }
                
                if (userProfile.business_type) {
                    const suggestion = boardSuggestions[userProfile.business_type];
                    if (suggestion && suggestion.tip) {
                        boardSuggestionDiv.innerHTML = `<i class="fas fa-lightbulb"></i> <strong>Suggestion:</strong> ${suggestion.tip}`;
                        boardSuggestionDiv.style.display = 'block';
                    }
                }
            }
            showModal();
        });

        const savedProfile = localStorage.getItem('agvisorProfile');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            updateProfileSummary();
            renderSidebar();
            
            fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    ...userProfile
                })
            });
        } else {
            renderSidebar();
            showModal();
        }


        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            isLoading = true;
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/chat/all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                
                removeLoadingMessage(loadingId);

                if (data.error) {
                    addMessage('Sorry, there was an error processing your request. Please try again.', 'error');
                } else {
                    addAllAdvisorResponses(data.responses);
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('Sorry, there was a connection error. Please try again.', 'error');
            }

            isLoading = false;
        });

        clearBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                chatMessages.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h2>Conversation Cleared</h2>
                        <p>Start a new conversation with your advisory board.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        });

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="fas fa-user"></i>
                        <span>You</span>
                    </div>
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            } else {
                messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAllAdvisorResponses(responses) {
            const containerDiv = document.createElement('div');
            containerDiv.className = 'advisor-responses-container';
            
            responses.forEach(resp => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'advisor-response';
                responseDiv.innerHTML = `
                    <div class="advisor-response-header">
                        <i class="fas fa-${resp.icon}"></i>
                        <span class="advisor-title">${resp.title}</span>
                    </div>
                    <div class="advisor-response-content">${formatMessage(resp.response)}</div>
                `;
                containerDiv.appendChild(responseDiv);
            });
            
            chatMessages.appendChild(containerDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingMessage() {
            const id = 'loading_' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message loading';
            messageDiv.id = id;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <i class="fas fa-users"></i>
                    <span class="advisor-name">Advisory Board</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeLoadingMessage(id) {
            const loadingMsg = document.getElementById(id);
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }
    </script>
</body>
</html>

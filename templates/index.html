<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agvisor - AI Advisory for Agricultural Businesses</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="onboardingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-tractor"></i>
                </div>
                <h2>Welcome to Agvisor</h2>
                <p>Set up your farm profile to get personalized advice from our AI advisory board</p>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label for="farmName">Farm Name (Optional)</label>
                    <input type="text" id="farmName" placeholder="e.g., Green Valley Farm">
                </div>
                
                <div class="form-group">
                    <label for="stateSelect">State <span class="required">*</span></label>
                    <select id="stateSelect" required>
                        <option value="">Select your state...</option>
                        {% for state in states %}
                        <option value="{{ state }}">{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Livestock</label>
                    <p class="form-hint">Enter the livestock you raise (comma separated)</p>
                    <input type="text" id="livestockInput" placeholder="e.g., Beef Cattle, Dairy Cattle, Chickens">
                </div>

                <div class="form-group">
                    <label>Crops & Products</label>
                    <p class="form-hint">Enter the crops you grow (comma separated)</p>
                    <input type="text" id="cropsInput" placeholder="e.g., Corn, Soybeans, Wheat">
                </div>
                
                <p class="form-hint" style="margin-top: -0.5rem; margin-bottom: 1rem; color: #c44;">* Please enter at least one livestock or crop</p>
                
                <div class="form-group">
                    <label>Business Records (Optional)</label>
                    <p class="form-hint">Upload a CSV or spreadsheet with your farm's financial or production data</p>
                    <div class="file-upload-wrapper">
                        <input type="file" id="businessRecords" accept=".csv,.xlsx,.xls">
                        <div class="file-upload-label" id="fileLabel">
                            <i class="fas fa-file-upload"></i>
                            <span>Choose a file or drag it here</span>
                        </div>
                    </div>
                    <p class="form-hint" id="fileStatus" style="margin-top: 0.5rem; color: var(--primary-green); display: none;"></p>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-arrow-right"></i> Start Getting Advice
                </button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-tractor"></i>
                <h1>Agvisor</h1>
            </div>
            <div class="header-right">
                <button class="profile-btn" id="editProfileBtn" title="Edit Profile">
                    <i class="fas fa-user-cog"></i>
                    <span id="profileSummary">Set up profile</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h2>Your Advisory Board</h2>
                <div class="advisor-list">
                    {% for id, advisor in advisors.items() %}
                    <div class="advisor-card" data-advisor="{{ id }}">
                        <div class="advisor-icon">
                            <i class="fas fa-{{ advisor.icon }}"></i>
                        </div>
                        <div class="advisor-info">
                            <h3>{{ advisor.title }}</h3>
                            <p class="specialty">{{ advisor.specialty }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="clear-btn" id="clearChat">
                    <i class="fas fa-trash-alt"></i> Clear Conversation
                </button>
            </aside>

            <main class="chat-area">
                <div class="chat-header">
                    <div class="current-advisor">
                        <span>Advisory Board Mode: </span>
                        <strong>All Advisors</strong>
                        <span class="advisor-title">Ask a question to get input from all board members</span>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h2>Welcome to Your Agricultural Advisory Board</h2>
                        <p>Select an advisor from the left panel and ask any question about your agricultural business. Our AI-powered experts are here to help with:</p>
                        <ul>
                            <li><i class="fas fa-check"></i> Crop planning and soil management</li>
                            <li><i class="fas fa-check"></i> Financial planning and investment decisions</li>
                            <li><i class="fas fa-check"></i> Operations optimization and logistics</li>
                            <li><i class="fas fa-check"></i> Marketing strategies and sales growth</li>
                            <li><i class="fas fa-check"></i> Sustainability practices and certifications</li>
                            <li><i class="fas fa-check"></i> Federal and state agricultural regulations</li>
                        </ul>
                    </div>
                </div>

                <div class="chat-input-area">
                    <form id="chatForm">
                        <div class="input-wrapper">
                            <textarea 
                                id="messageInput" 
                                placeholder="Ask your agricultural advisor a question..."
                                rows="1"
                            ></textarea>
                            <button type="submit" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <script>
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let currentAdvisor = 'agronomist';
        let isLoading = false;
        let userProfile = null;

        const modal = document.getElementById('onboardingModal');
        const profileForm = document.getElementById('profileForm');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const chatForm = document.getElementById('chatForm');
        const advisorCards = document.querySelectorAll('.advisor-card');
        const clearBtn = document.getElementById('clearChat');
        const currentAdvisorName = document.getElementById('currentAdvisorName');
        const currentAdvisorTitle = document.getElementById('currentAdvisorTitle');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const profileSummary = document.getElementById('profileSummary');

        const advisorData = {
            {% for id, advisor in advisors.items() %}
            '{{ id }}': {
                title: '{{ advisor.title }}',
                specialty: '{{ advisor.specialty }}',
                icon: '{{ advisor.icon }}'
            },
            {% endfor %}
        };

        function showModal() {
            modal.style.display = 'flex';
        }

        function hideModal() {
            modal.style.display = 'none';
        }

        function updateProfileSummary() {
            if (userProfile && userProfile.state) {
                let summary = userProfile.state;
                let items = [];
                if (userProfile.livestock && userProfile.livestock.length > 0) {
                    items.push(`${userProfile.livestock.length} livestock`);
                }
                if (userProfile.crops && userProfile.crops.length > 0) {
                    items.push(`${userProfile.crops.length} crop${userProfile.crops.length > 1 ? 's' : ''}`);
                }
                if (items.length > 0) {
                    summary += ` - ${items.join(', ')}`;
                }
                profileSummary.textContent = summary;
            } else {
                profileSummary.textContent = 'Set up profile';
            }
        }

        const fileInput = document.getElementById('businessRecords');
        const fileLabel = document.getElementById('fileLabel');
        const fileStatus = document.getElementById('fileStatus');
        let uploadedFile = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                fileLabel.innerHTML = `<i class="fas fa-file-check"></i><span>${file.name}</span>`;
                fileLabel.classList.add('file-selected');
            }
        });

        async function uploadBusinessRecords() {
            if (!uploadedFile) return true;
            
            const formData = new FormData();
            formData.append('file', uploadedFile);
            formData.append('session_id', sessionId);
            
            try {
                const response = await fetch('/api/upload-records', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error uploading file: ' + data.error);
                    return false;
                }
                
                fileStatus.textContent = `Uploaded: ${data.row_count} records processed`;
                fileStatus.style.display = 'block';
                return true;
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading file. Please try again.');
                return false;
            }
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const farmName = document.getElementById('farmName').value;
            const state = document.getElementById('stateSelect').value;
            
            const livestockInput = document.getElementById('livestockInput').value.trim();
            const livestock = livestockInput ? livestockInput.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const cropsInput = document.getElementById('cropsInput').value.trim();
            const crops = cropsInput ? cropsInput.split(',').map(s => s.trim()).filter(s => s) : [];
            
            if (!state) {
                alert('Please select your state');
                return;
            }
            
            if (crops.length === 0 && livestock.length === 0) {
                alert('Please enter at least one livestock or crop');
                return;
            }
            
            userProfile = { farm_name: farmName, state, livestock, crops };
            
            try {
                if (uploadedFile) {
                    const uploadSuccess = await uploadBusinessRecords();
                    if (!uploadSuccess) return;
                }
                
                await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        ...userProfile
                    })
                });
                
                updateProfileSummary();
                hideModal();
                
                localStorage.setItem('agvisorProfile', JSON.stringify(userProfile));
                uploadedFile = null;
            } catch (error) {
                console.error('Error saving profile:', error);
            }
        });

        editProfileBtn.addEventListener('click', () => {
            if (userProfile) {
                document.getElementById('farmName').value = userProfile.farm_name || '';
                document.getElementById('stateSelect').value = userProfile.state || '';
                document.getElementById('livestockInput').value = (userProfile.livestock || []).join(', ');
                document.getElementById('cropsInput').value = (userProfile.crops || []).join(', ');
            }
            showModal();
        });

        const savedProfile = localStorage.getItem('agvisorProfile');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            updateProfileSummary();
            
            fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    ...userProfile
                })
            });
        } else {
            showModal();
        }


        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            isLoading = true;
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/chat/all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                
                removeLoadingMessage(loadingId);

                if (data.error) {
                    addMessage('Sorry, there was an error processing your request. Please try again.', 'error');
                } else {
                    addAllAdvisorResponses(data.responses);
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('Sorry, there was a connection error. Please try again.', 'error');
            }

            isLoading = false;
        });

        clearBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                chatMessages.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h2>Conversation Cleared</h2>
                        <p>Start a new conversation with your agricultural advisors.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        });

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="fas fa-user"></i>
                        <span>You</span>
                    </div>
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            } else {
                messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAllAdvisorResponses(responses) {
            const containerDiv = document.createElement('div');
            containerDiv.className = 'advisor-responses-container';
            
            responses.forEach(resp => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'advisor-response';
                responseDiv.innerHTML = `
                    <div class="advisor-response-header">
                        <i class="fas fa-${resp.icon}"></i>
                        <span class="advisor-title">${resp.title}</span>
                    </div>
                    <div class="advisor-response-content">${formatMessage(resp.response)}</div>
                `;
                containerDiv.appendChild(responseDiv);
            });
            
            chatMessages.appendChild(containerDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingMessage() {
            const id = 'loading_' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message loading';
            messageDiv.id = id;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <i class="fas fa-users"></i>
                    <span class="advisor-name">Advisory Board</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeLoadingMessage(id) {
            const loadingMsg = document.getElementById(id);
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }
    </script>
</body>
</html>
